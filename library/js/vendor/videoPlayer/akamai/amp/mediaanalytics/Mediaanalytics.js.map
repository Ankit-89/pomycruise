{"version":3,"file":"Mediaanalytics.js","sources":["../../../../src/MediaAnalytics.js","../../../../src/main.js"],"sourcesContent":["export default class MediaAnalytics extends akamai.amp.Plugin {\n\n  static create(player, config) {\n    window.AKAMAI_MEDIA_ANALYTICS_CONFIG_FILE_PATH = config.config\n    return akamai.amp.AMP.addResources(config.sdk)\n      .then(() => {\n        return super.create(player, config)\n      })\n  }\n\n  constructor(player, config) {\n    super(player, config)\n  }\n\n  setDimensions(value) {\n    let dimensions = this.config.dimensions\n    for (let key in value) {\n      let val = value[key]\n      if (val != null) {\n        dimensions[key] = val // TODO: Does this need to be evaluated for bindings?\n      }\n    }\n    this.applyDimensions(dimensions)\n    return value\n  }\n\n  applyDimensions(dimensions) {\n    if (typeof window.setAkamaiMediaAnalyticsData != \"function\")\n      return\n\n    try {\n      for (let key in dimensions) {\n        setAkamaiMediaAnalyticsData(key, dimensions[key])\n      }\n    }\n    catch (error) {\n      this.player.logger.error(\"[AMP MEDIA ANALYTICS ERROR]\", \"Could not set dimensions:\", error)\n    }\n\n    if (this.config.iplookup === false && typeof akamaiDisableServerIpLookup === \"function\") {\n       akamaiDisableServerIpLookup()\n    }\n  }\n\n  onready(event) {\n    try {\n      if (this.debug === true) {\n        window.AkamaiAnalytics_debug = 1\n      }\n      window.akamaiSetVideoObject(this.player.mediaElement)\n    }\n    catch (error) {\n      this.player.logger.error(\"[AMP MEDIA ANALYTICS ERROR]\", \"Could not set video tag\", error)\n    }\n\n    let ads = this.player.ads\n    if (ads == null)\n      return\n\n    ads.addEventListener(\"breakstart\", this.onadbreakstart.bind(this))\n    ads.addEventListener(\"breakend\", this.onadbreakend.bind(this))\n    ads.addEventListener(\"loaded\", this.onadloaded.bind(this))\n    ads.addEventListener(\"started\", this.onadstarted.bind(this))\n    ads.addEventListener(\"ended\", this.onadended.bind(this))\n\n    ads.addEventListener(\"firstquartile\", this.onadfirstquartile.bind(this))\n    ads.addEventListener(\"midpoint\", this.onadmidpoint.bind(this))\n    ads.addEventListener(\"thirdquartile\", this.onadthirdquartile.bind(this))\n  }\n\n  onmediachange(event) {\n    let media = event.detail\n    let dimensions = null\n\n    if (typeof akamaiSetStreamURL === \"function\") {\n      akamaiSetStreamURL(media.src, false)\n    }\n\n    let viewerId = this.config.viewerId || this.config.viewerID || this.config[\"std:viewerId\"]\n    if (viewerId != null && typeof akamaiSetViewerId == \"function\") {\n      akamaiSetViewerId(viewerId)\n    }\n\n    let config = media.mediaanalytics\n    if (config != null && config.dimensions != null) {\n      dimensions = akamia.amp.Utils.override(this.config.dimensions, config.dimensions)\n    } else {\n      dimensions = this.config.dimensions\n    }\n\n    if (typeof akamaiHandleStreamSwitch === \"function\") {\n      akamaiHandleStreamSwitch()\n    }\n\n    this.applyDimensions(dimensions)\n  }\n\n  updateMedia(media) {\n    if (typeof akamaiHandleTitleSwitch === \"function\") {\n      akamaiHandleTitleSwitch(media)\n    }\n  }\n\n  onfragmentloadstart(event) {\n    if (typeof fragmentDownloadStarted === \"function\") {\n      fragmentDownloadStarted(event.detail)\n    }\n  }\n\n  onfragmentloaded(event) {\n    if (typeof fragmentDownloadCompleted === \"function\") {\n      fragmentDownloadCompleted(event.detail)\n    }\n  }\n\n  onbitratechange(event) {\n    if (typeof akamaiHandleBitRateSwitch === \"function\") {\n      akamaiHandleBitRateSwitch(event.detail.bitrate)\n    }\n  }\n\n  onadbreakstart() {\n    this.player.mediaElement.dataset.isad = true\n  }\n\n  onadbreakend() {\n    this.player.mediaElement.dataset.isad = false\n  }\n\n  onadloaded(event) {\n    try {\n      let adVO = event.data\n      let adObject = {\n        adDuration: adVO.duration,\n        adPartnerId: adVO.partner,\n        adTitle: adVO.title,\n        adId: adVO.id\n      }\n\n      if (typeof akamaiHandleAdLoaded === \"function\") {\n        akamaiHandleAdLoaded(adObject)\n      }\n    }\n    catch (error) {\n      this.player.logger.error(\"[AMP MEDIA ANALYTICS ERROR]\", error)\n    }\n  }\n\n  onadstarted() {\n    if (typeof akamaiHandleAdStarted === \"function\") {\n      akamaiHandleAdStarted()\n    }\n  }\n\n  onadfirstquartile() {\n    if (typeof akamaiHandleAdFirstQuartile === \"function\") {\n      akamaiHandleAdFirstQuartile()\n    }\n  }\n\n  onadmidpoint() {\n    if (typeof akamaiHandleAdMidpoint === \"function\") {\n      akamaiHandleAdMidpoint()\n    }\n  }\n\n  onadthirdquartile() {\n    if (typeof akamaiHandleAdThirdQuartile === \"function\") {\n      akamaiHandleAdThirdQuartile()\n    }\n  }\n\n  onadended() {\n    if (typeof akamaiHandleAdCompleted === \"function\") {\n      akamaiHandleAdCompleted()\n    }\n    // TODO: Why is this here?\n    this.player.getMediaElement().dataset.isad = true\n  }\n}\n","import MediaAnalytics from \"./MediaAnalytics.js\"\n\nakamai.amp.AMP.registerPlugin(\"mediaanalytics\", MediaAnalytics.factory)\n\nexport {MediaAnalytics}\n"],"names":["MediaAnalytics","player","config","AKAMAI_MEDIA_ANALYTICS_CONFIG_FILE_PATH","akamai","amp","AMP","addResources","sdk","then","value","dimensions","key","val","applyDimensions","window","setAkamaiMediaAnalyticsData","error","logger","iplookup","akamaiDisableServerIpLookup","event","debug","AkamaiAnalytics_debug","akamaiSetVideoObject","mediaElement","ads","addEventListener","onadbreakstart","bind","onadbreakend","onadloaded","onadstarted","onadended","onadfirstquartile","onadmidpoint","onadthirdquartile","media","detail","akamaiSetStreamURL","src","viewerId","viewerID","akamaiSetViewerId","mediaanalytics","akamia","Utils","override","akamaiHandleStreamSwitch","akamaiHandleTitleSwitch","fragmentDownloadStarted","fragmentDownloadCompleted","akamaiHandleBitRateSwitch","bitrate","dataset","isad","adVO","data","adObject","duration","partner","title","id","akamaiHandleAdLoaded","akamaiHandleAdStarted","akamaiHandleAdFirstQuartile","akamaiHandleAdMidpoint","akamaiHandleAdThirdQuartile","akamaiHandleAdCompleted","getMediaElement","Plugin","registerPlugin","factory"],"mappings":"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"}